---
title: "Thorchain: Standardized TVL over time (all pools)"
author: "laz97"
date: '2022-04-22'
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---

## Introduction
A common criticism against traditional TVL metrics is that they are heavily influenced by the price fluctuations of the "locked" tokens. In this dashboard, we propose two different TVL-like metrics that provide a solution to this problem, one of which, in our opinion, provides superior economic interpretability. We then apply these metrics to Thorchain liquidity pools.

We start with a brief discussion of TVL and our two proposed alternatives:  Normalized TVL and Dolar Value Locked. In this section, we explain their economic interpretability.

Then, we calculate these metrics for the aggregate of all liquidity pools in Thorchain and compare the evolution of the metrics through time, to see how they relate to each other.

Following that, we estimate all three metrics for the aggregate of the liquidity pools pertaining to each blockchain available in Thorchain and compare the evolution of the chains through time.

Finally, we estimate the three metrics for all liquidity pools in Thorchain, segmenting liquidity pools by charts based on the blockchain of the asset of interest.

Additionally, we provide an addendum that explains how our metrics relate to those calculated by Flipsidecrypto in its thorchain.daily_tvl table.

All data used on this document comes from Flipsidecrypto's thorchain.daily_tvl table and thorchain.daily_pool_stats. The corresponding queries used to extract the data can be found [here](https://app.flipsidecrypto.com/velocity/queries/a5326b81-d778-465e-9d77-85ed891afabe) and [here](https://app.flipsidecrypto.com/velocity/queries/29a931d0-093a-406d-9adf-90abaf44d773). The code underlying this document can be found [here]().

## TVL and two alterntives
At its core, TVL (when denominated in USD) is the sum of the value (in USD) of all the tokens "locked" in a particular protocol/pool/program/etc. What this means is that the price fluctuation of such tokens have an effect in traditional TVL measures. On the one hand, the interpretability of the TVL metric is quite straightforward: the value of all assets in a specific pool/protocol/program/etc. On the other hand, the fact that it moves with price fluctuations is a disadvantage: it is not entirely clear that we should always be using the USD as the base currency of all DEFI applications at all times.

As an example of the disadvantage explained below, imagine a protocol that quickly "raised" tokens shortly after launch, but then stalls for a prolonged period of time, neither losing locked tokens nor gaining new ones (net). For this protocol, the TVL would be heavily dominated by the price fluctuation of its underlying tokens and would tell us very little about how it has gained in adoption and popularity.

For this reason we propose two new metrics that should be seen as complementary to TVL (not substitutes):

**Normalized TVL**: normalizes TVL by using the last known price of the underlying tokens instead of historical prices. In this regard, the most current Normalized TVL will equal regular TVL, but historical values will be less riddled with "noise" (generated by price fluctuations) if we want to assess possible changes in the adoption of the protocol.

Its main advantage is the ease of its calculation and its similarity to the commonplace TVL metric. However, it suffers from the fact that its historical values have no clear economic interpretation when seen in isolation (it does provide value when compared to TVL).

**Dollar value locked**: is calculated using the dollar value of each deposit and withdrawal into a protocol (or a good approximation). The cumulative net sum of this value gives the Dollar Value Locked and can be interpreted as the amount of USD that has ever been deposited (net of withdrawals) into a protocol.

So basically, instead of it giving the dollar value of the locked assets, it gives the dollar value that has been deposited into the protocol, muting the effect of the price fluctuations on the metric and providing a clear economic interpretation.

Furthermore, by simple arithmetic and the identity $ TVL = DolarValueLocked + DolarValueGained $ we can estimate the impact of the price fluctuations in the underlying assets on the TVL.

Each of these metrics provides advantages against TVL if we want to abstract the effect of price fluctuations of the underlying assets. However, of the two, Dollar Value Locked provides better interpretability while Normalized TVL is easier to calculate and is more similar to TVL.

## Thorchain and its TVL metrics
In this section, using the aggregate locked value of Thorchain pools, we plot the different TVL metrics against each other to assess their behavior.

It is important to note that our TVL calculation is similar to what Flipsidecrypto calls "Total Value Pooled", insofar it does not include the value "bonded" into pools. In the addendum, we plot Flipsidecrypto's Total Value Pooled against or TVL (regular) calculation that proves to be an incredibly close match.


```{r setup ,results = 'hide', echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Libraries
library(pacman)
pacman::p_load(tidyverse, dbplyr, RSQLite, lubridate, openxlsx, here, geckor, tidyquant, data.table, igraph, tidygraph, ggraph, visNetwork, networkD3, RColorBrewer, ggdark, plotly, scales, reactable)

#Get data
TVL_pool <- jsonlite::fromJSON("https://api.flipsidecrypto.com/api/v2/queries/29a931d0-093a-406d-9adf-90abaf44d773/data/latest") %>% 
  as_tibble(.) %>%
  mutate(DAY = as.Date(DAY, format = "%Y-%m-%d")) %>%
  group_by(POOL_NAME) %>%
  arrange(DAY) %>%
  mutate(NET_ADDED_LIQUIDITY_USD = ADDED_LIQUIDITY_USD - WITHDRAWN_LIQUIDITY_USD,
         DOLAR_VALUE_POOLED = cumsum(NET_ADDED_LIQUIDITY_USD),
         DOLAR_VALUE_GAINED = TVL - DOLAR_VALUE_POOLED,
         LAST_ASSET_PRICE_USD = last(ASSET_PRICE_USD),
         LAST_RUNE_PRICE_USD = last(RUNE_PRICE_USD),
         NORMALIZED_TVL = ASSET_LIQUIDITY * LAST_ASSET_PRICE_USD + RUNE_LIQUIDITY * LAST_RUNE_PRICE_USD) %>%
  ungroup() %>%
  right_join(., expand(., DAY, POOL_NAME), by = c("DAY", "POOL_NAME")) %>%
  arrange(DAY) %>%
  group_by(POOL_NAME) %>%
  fill(., DOLAR_VALUE_POOLED, DOLAR_VALUE_GAINED, TVL, NORMALIZED_TVL, .direction = "down") %>%
  ungroup() %>%
  drop_na(., DOLAR_VALUE_POOLED) %>%
  group_by(POOL_NAME) %>%
  arrange(DAY) %>%
  ungroup() %>%
  rename(DOLAR_VALUE_LOCKED = DOLAR_VALUE_POOLED) %>%
  mutate(BLOCKCHAIN = str_extract(POOL_NAME, "^[:alnum:]+"),
         TOKEN = str_extract(POOL_NAME, "(?<=\\.)[:alnum:]+(?=$|-)"))
  

TVL <- jsonlite::fromJSON("https://api.flipsidecrypto.com/api/v2/queries/a5326b81-d778-465e-9d77-85ed891afabe/data/latest") %>% 
  as_tibble(.) %>%
  mutate(DAY = as.Date(DAY, format = "%Y-%m-%d"))
```



```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#Normalized value locked, dolar value pooled and TVL
p0 <- TVL_pool %>%
  group_by(DAY) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            NORMALIZED_TVL = sum(NORMALIZED_TVL),
            TVL = sum(TVL)) %>%
  pivot_longer(., c(DOLAR_VALUE_LOCKED, TVL, NORMALIZED_TVL), names_to = "VARIABLE", values_to = 'VALUE') %>%
  ggplot(., aes(x = DAY, y = VALUE, group = VARIABLE, color = VARIABLE)) +
  geom_line() +
  ggtitle("Dolar value locked, normalized TVL and TVL") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p0)
```

As we can see in the plot above, both the Normalized TVL and the Dollar Value Locked metrics are quite successful in removing the "noise" generated by the underlying assets' price fluctuations. Furthermore, both metrics are closely related to each other in their movements but have significantly different values in the latter days of the period.

Regarding Thorchain, the proposed metrics show us that it has consistently been "locking" value since inception, with relatively brief periods of small net positive outflows. This tells us that most of the downward movements on the traditional TVL metric are related to price changes of the underlying assets instead of withdrawals from the pools.

Using the properties of the relationship between the Dollar Value Locked metric and the regular TVL metric, we can even estimate the effects of the price changes on TVL, as shown in the chart below.

```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#Dollar value pooled and gained
p1 <- TVL_pool %>%
  group_by(DAY) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            DOLAR_VALUE_GAINED = sum(DOLAR_VALUE_GAINED),
            TVL = sum(TVL)) %>%
  pivot_longer(., c(DOLAR_VALUE_LOCKED, DOLAR_VALUE_GAINED, TVL), names_to = "VARIABLE", values_to = 'VALUE') %>%
  ggplot(., aes(x = DAY, y = VALUE, group = VARIABLE, color = VARIABLE)) +
  geom_line() +
  ggtitle("Dolar value locked, price fluctuation gains, and TVL") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p1)
```

As we can see, price fluctuations explain most of the short-term variability in TVL and have been a net drag on TVL to date (in aggregate, investors that deposited into pools have lost "nominal value" - they likely more than made up for this loss with "yield").

## TVL metrics by chain
In this section, we plot TVL, Normalized TVL, and Dollar Locked Value for the aggregate of pools whose main asset belongs to each particular chain against each other. The first plot corresponds to TVL, the second to Normalized TVL, and the third to Dollar Value Locked.

```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#By chain
#TVL by chain
p2 <- TVL_pool %>% 
  group_by(DAY, BLOCKCHAIN) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            NORMALIZED_TVL = sum(NORMALIZED_TVL),
            TVL = sum(TVL), .groups = "drop") %>%
  ggplot(., aes(x = DAY, y = TVL, group = BLOCKCHAIN, color = BLOCKCHAIN)) +
  geom_line() +
  ggtitle("TVL by Chain") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p2)
```


```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#Normalized TVL by chain
p3 <- TVL_pool %>% 
  group_by(DAY, BLOCKCHAIN) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            NORMALIZED_TVL = sum(NORMALIZED_TVL),
            TVL = sum(TVL), .groups = "drop") %>%
  ggplot(., aes(x = DAY, y = NORMALIZED_TVL, group = BLOCKCHAIN, color = BLOCKCHAIN)) +
  geom_line() +
  ggtitle("Normalized TVL by Chain") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p3)
```


```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#Dolar value pooled by blockchain
p4 <- TVL_pool %>% 
  group_by(DAY, BLOCKCHAIN) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            NORMALIZED_TVL = sum(NORMALIZED_TVL),
            TVL = sum(TVL), .groups = "drop") %>%
  ggplot(., aes(x = DAY, y = DOLAR_VALUE_LOCKED, group = BLOCKCHAIN, color = BLOCKCHAIN)) +
  geom_line() +
  ggtitle("Dolar value locked by Chain") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p4)
```

Ethereum is the top chain in Thorchain by all metrics, followed by Binance Chain, Bitcoin, and, quite remarkably given its very recent addition to Thorchain, Terra. The last three chains, Doge, BCH, and Lite trail far behind. 

## TVL metrics by chain
Here, we plot the TVL metrics for each pool. Plots are segmented by chain and metric. This means that there are three plots for each chain: one with the TVL of each of its pools, one with normalized TVL, and one with the Dollar Value Locked.

We will leave the analysis of these charts to the reader.


#### Bitcoin Cash
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#By coins repeated for each chain
TVLByChainAndToken <- function(blockchain) {

#TVL
  Plot0 <- TVL_pool %>% 
    filter(BLOCKCHAIN == blockchain) %>%
    group_by(DAY, BLOCKCHAIN, TOKEN) %>%
    summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
              NORMALIZED_TVL = sum(NORMALIZED_TVL),
              TVL = sum(TVL), .groups = "drop") %>%
    ggplot(., aes(x = DAY, y = TVL, group = TOKEN, color = TOKEN)) +
    geom_line() +
    ggtitle(paste("TVL -",blockchain)) +
    xlab("Date") + 
    ylab("Value (USD)") +
    scale_y_continuous(labels = comma_format())
  
  ggP0 <- ggplotly(Plot0)
  
#Normalized TVL
  Plot1 <- TVL_pool %>% 
    filter(BLOCKCHAIN == blockchain) %>%
    group_by(DAY, BLOCKCHAIN, TOKEN) %>%
    summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
              NORMALIZED_TVL = sum(NORMALIZED_TVL),
              TVL = sum(TVL), .groups = "drop") %>%
    ggplot(., aes(x = DAY, y = NORMALIZED_TVL, group = TOKEN, color = TOKEN)) +
    geom_line() +
    ggtitle(paste("Normalized TVL -",blockchain)) +
    xlab("Date") + 
    ylab("Value (USD)") +
    scale_y_continuous(labels = comma_format())
  
  ggP1 <- ggplotly(Plot1)
  
#Dolar value locked  
Plot2 <- TVL_pool %>% 
  filter(BLOCKCHAIN == blockchain) %>%
  group_by(DAY, BLOCKCHAIN, TOKEN) %>%
  summarise(DOLAR_VALUE_LOCKED = sum(DOLAR_VALUE_LOCKED),
            NORMALIZED_TVL = sum(NORMALIZED_TVL),
            TVL = sum(TVL), .groups = "drop") %>%
  ggplot(., aes(x = DAY, y = DOLAR_VALUE_LOCKED, group = TOKEN, color = TOKEN)) +
  geom_line() +
  ggtitle(paste("Dolar value locked -",blockchain)) +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggP2 <- ggplotly(Plot2)

list(ggP0, ggP1, ggP2)

}

chains <- TVL_pool %>%
  distinct(BLOCKCHAIN) %>%
  pull(.)

TVL_BY_TOKENS <- lapply(setNames(chains,chains), TVLByChainAndToken)

TVL_BY_TOKENS[["BCH"]][[1]]
TVL_BY_TOKENS[["BCH"]][[2]]
TVL_BY_TOKENS[["BCH"]][[3]]
```

#### Binance Chain
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["BNB"]][[1]]
TVL_BY_TOKENS[["BNB"]][[2]]
TVL_BY_TOKENS[["BNB"]][[3]]
```

#### Ethereum
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["ETH"]][[1]]
TVL_BY_TOKENS[["ETH"]][[2]]
TVL_BY_TOKENS[["ETH"]][[3]]
```

### Bitcoin
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["BTC"]][[1]]
TVL_BY_TOKENS[["BTC"]][[2]]
TVL_BY_TOKENS[["BTC"]][[3]]
```

#### Litecoin
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["LTC"]][[1]]
TVL_BY_TOKENS[["LTC"]][[2]]
TVL_BY_TOKENS[["LTC"]][[3]]
```

#### Dogecoin
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["DOGE"]][[1]]
TVL_BY_TOKENS[["DOGE"]][[2]]
TVL_BY_TOKENS[["DOGE"]][[3]]
```

#### Terra
```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
TVL_BY_TOKENS[["TERRA"]][[1]]
TVL_BY_TOKENS[["TERRA"]][[2]]
TVL_BY_TOKENS[["TERRA"]][[3]]
```

## Addendum

The plot below shows the comparison of our TVL calculation against Flipsidecrypto's "Total Value Pooled" calculation, to show that they closely resemble each other.

```{r fig.width=9, fig.height=6, fig.align='center', include = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}
#Addendum (Value locked vs value pooled)
p5 <- TVL_pool %>%
  group_by(DAY) %>%
  summarise(TVL = sum(TVL)) %>%
  left_join(., TVL %>% select(., DAY, TOTAL_VALUE_POOLED_USD), by = "DAY") %>%
  pivot_longer(., c(TVL, TOTAL_VALUE_POOLED_USD), names_to = "VARIABLE", values_to = 'VALUE') %>%
  ggplot(., aes(x = DAY, y = VALUE, group = VARIABLE, color = VARIABLE)) +
  geom_line() +
  ggtitle("TVL (our calculations) and Total Value Pooled (Flipside)") +
  xlab("Date") + 
  ylab("Value (USD)") +
  scale_y_continuous(labels = comma_format())

ggplotly(p5)
```
